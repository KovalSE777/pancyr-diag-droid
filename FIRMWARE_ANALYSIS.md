# Полный анализ прошивки и исправленные ошибки

## Исходные файлы прошивки
- `pprpzu_45k22_Blt_Pancir-7.c` - основной файл БСКУ
- `UNIVUP_25k22-7.c` - модуль индикации  
- `indic_45k22-6.asm` - ассемблерный модуль

## Критические ошибки найденные и исправленные

### 1. Неправильные UDS адреса (ИСПРАВЛЕНО ✅)
**Было:**
```typescript
private readonly BSKU_ADDRESS = 0x2A;
private readonly TESTER_ADDRESS = 0xF1;
```

**Стало (согласно строке 116-124 прошивки):**
```typescript
private readonly BSKU_ADDRESS = 0x28;  // DST в запросе к ECU
private readonly TESTER_ADDRESS = 0xF0; // SRC в запросе от тестера
```

**Источник:** `pprpzu_45k22_Blt_Pancir-7.c` строки 116-124:
```c
rom const char cmnd[]={
116: 4,0x80,0x28,0xf0,0x81,0xff,0xff,0xff,//0  startCommunication
120: 5,0x80,0x28,0xf0,0x3e,0x01,0xff,0xff,//4  testerPresent 02-NO
124: 5,0x80,0x28,0xf0,0x21,0x01,0xff,0xff,//8  readDataByLocalIdentifier
```

### 2. Неправильный код сервиса в ответе (ИСПРАВЛЕНО ✅)
**Было:** Ожидали `service === 0x21`

**Стало:** Ожидаем `service === 0x61` (позитивный ответ на 0x21)

**Источник:** `pprpzu_45k22_Blt_Pancir-7.c` строки 715-721:
```c
//Ответ на команду считывания
if((buf_in2[3]==0x61)&&(buf_in2[1]==0xf1))
{
    schetcik5=20;
    oper2=3;
    f_stend_hand=1;
    cikl_K_line++;
}
```

### 3. Неправильное извлечение данных из пакета (ИСПРАВЛЕНО ✅)
**Было:** `packet.slice(5, totalLen - 1)` - начинали со смещения 5

**Стало:** `packet.slice(4, totalLen - 1)` - начинаем со смещения 4

**Источник:** `pprpzu_45k22_Blt_Pancir-7.c` строки 1116-1148:
```c
ip2=4;  // Начинаем с индекса 4 (после LEN, DST, SRC, SERVICE)
//
U_U_UM1=res2[ip2++];  // Первый байт данных
U_U_UM2=res2[ip2++];
...
```

### 4. Неправильная проверка адресов в ответе (ИСПРАВЛЕНО ✅)
Прошивка отвечает с **перевернутыми адресами**:
- Запрос: DST=0x28, SRC=0xF0
- Ответ: DST=0xF1, SRC=0x28

Добавлена проверка:
```typescript
if (dst !== 0xF1 || src !== 0x28) {
  logService.warn('BLE-RX', `Unexpected addresses...`);
}
```

## Протокол UDS согласно прошивке

### Формат пакета запроса:
```
[LEN] [DST] [SRC] [SERVICE] [DATA...] [CHECKSUM]
```

Где:
- `LEN = 0x80 | (N-2)` - длина (N = количество байт от DST до последнего байта данных)
- `DST = 0x28` - адрес ECU (БСКУ)
- `SRC = 0xF0` - адрес тестера
- `SERVICE` - код сервиса UDS
- `CHECKSUM` - сумма всех предыдущих байт (mod 256)

### Формат пакета ответа:
```
[LEN] [DST] [SRC] [SERVICE] [DATA...] [CHECKSUM]
```

Где:
- `DST = 0xF1` - адрес тестера (получатель)
- `SRC = 0x28` - адрес ECU (отправитель)
- `SERVICE = 0x61` - позитивный ответ на ReadDataByLocalIdentifier (0x21)

### Примеры команд (согласно строкам 116-124):

#### StartCommunication (0x81):
```
Запрос:  83 28 F0 81 1C
         │  │  │  │  └─ Checksum (0x83+0x28+0xF0+0x81=0x11C→0x1C)
         │  │  │  └──── Service: StartCommunication
         │  │  └─────── SRC: Tester (0xF0)
         │  └────────── DST: ECU (0x28)
         └───────────── LEN: 0x80|(3-2)=0x83
```

#### TesterPresent (0x3E 0x01):
```
Запрос:  84 28 F0 3E 01 87
         │  │  │  │  │  └─ Checksum
         │  │  │  │  └──── SubFunction: 0x01
         │  │  │  └─────── Service: TesterPresent
         │  │  └────────── SRC: Tester (0xF0)
         │  └───────────── DST: ECU (0x28)
         └──────────────── LEN: 0x80|(4-2)=0x84
```

#### ReadDataByLocalIdentifier (0x21 0x01):
```
Запрос:  84 28 F0 21 01 7E
         │  │  │  │  │  └─ Checksum
         │  │  │  │  └──── LocalID: 0x01
         │  │  │  └─────── Service: ReadDataByLocalIdentifier
         │  │  └────────── SRC: Tester (0xF0)
         │  └───────────── DST: ECU (0x28)
         └──────────────── LEN: 0x80|(4-2)=0x84

Ответ:   XX F1 28 61 [DATA...] CS
         │  │  │  │  │          └─ Checksum
         │  │  │  │  └──────────── Diagnostic data (26+ bytes)
         │  │  │  └─────────────── Service: 0x61 (positive response)
         │  │  └────────────────── SRC: ECU (0x28)
         │  └───────────────────── DST: Tester (0xF1)
         └──────────────────────── LEN: variable
```

## Структура диагностических данных

Согласно `pprpzu_45k22_Blt_Pancir-7.c` строки 1118-1148, данные начинаются с `res2[4]` (после UDS заголовка):

| Байт | Имя | Описание |
|------|-----|----------|
| 0 | U_U_UM1 | ADC напряжения конденсатора |
| 1 | U_U_UM2 | ADC напряжения испарителя |
| 2 | U_U_UM3 | ADC напряжения компрессора |
| 3 | U_U_FU | ADC эталонного напряжения (27В) |
| 4 | uUPR_BT | Управление реле (M1-M5, CMP) |
| 5 | uUPR_IND | Управление индикацией (Pr1-Pr4) |
| 6 | sDAT_BIT | Статусные биты |
| 7 | work_rej_cmp | Режим работы компрессора |
| 8 | vdlt_cnd_i | Падение напряжения конденсатора |
| 9 | vdlt_isp_i | Падение напряжения испарителя |
| 10 | vdlt_cmp_i | Падение напряжения компрессора |
| 11 | timer_off | Таймер отключения |
| 12 | work_rej_cnd | Режим работы конденсатора |
| 13 | work_rej_isp | Режим работы испарителя |
| 14 | edlt_cnd_i | Эталон падения напряжения конденсатора |
| 15 | edlt_isp_i | Эталон падения напряжения испарителя |
| 16 | edlt_cmp_i | Эталон падения напряжения компрессора |
| 17 | n_V_cnd | Активные вентиляторы конденсатора |
| 18 | PWM_spd | Скорость PWM (1/2) |
| 19 | s1_TMR2 | Длительность высокого уровня ШИМ |
| 20 | s0_TMR2 | Длительность низкого уровня ШИМ |
| 21 | T_air | Температура воздуха |
| 22 | T_isp | Температура испарителя |
| 23 | U_davl | Датчик давления (0-255) |
| 24 | iSOST_UPR1 | Статус управления 1 |
| 25 | iSOST_UPR2 | Статус управления 2 |

## Расшифровка битовых полей

### sDAT_BIT (байт 6):
```
Bit 0: D_DAVL    - Датчик давления
Bit 1: VKL_CMP   - Компрессор включен
Bit 2: BL_2      - Тип системы (0=СКА/2 вент., 1=СКЭ/3 вент.)
Bit 3: K_NORM    - Контакт нормальный (УПП)
Bit 4: FTD_NORM  - Фотодатчик нормальный (УПП)
Bit 5: BL2_1vnt  - 1 вентилятор испарителя
Bit 6: NO_V_CMP  - Нет вентилятора компрессора
```

### uUPR_BT (байт 4) - Управление реле:
```
Bit 0: UP_M1  - Реле M1 (вентилятор конденсатора 1)
Bit 1: UP_M2  - Реле M2 (вентилятор конденсатора 2)
Bit 2: UP_M3  - Реле M3 (вентилятор конденсатора 3 или испарителя)
Bit 3: UP_M4  - Реле M4 (вентилятор испарителя)
Bit 4: UP_M5  - Реле M5 (вентилятор испарителя/компрессора)
Bit 5: UP_CMP - Реле компрессора
```

### uUPR_IND (байт 5) - Предохранители:
```
Bit 0: Pr1 - Предохранитель эталон
Bit 1: Pr2 - Предохранитель конденсатора
Bit 2: Pr3 - Предохранитель испарителя
Bit 3: Pr4 - Предохранитель компрессора
```

### iSOST_UPR1 (байт 24) - Статусы ошибок 1:
```
Bit 0: zmk_V_isp1 - Замыкание вентилятора испарителя
Bit 1: obr_V_isp1 - Обрыв вентилятора испарителя
Bit 2: zmk_V_knd1 - Замыкание вентилятора конденсатора
Bit 3: obr_V_knd1 - Обрыв вентилятора конденсатора
```

### iSOST_UPR2 (байт 25) - Статусы ошибок 2:
```
Bit 0: zmk_COMP - Замыкание компрессора
Bit 1: obr_COMP - Обрыв компрессора
```

## Режимы работы (work_rej_*):
- `0` - Выключено (OFF)
- `1` - Включается
- `2` - Работает (ON)
- `10` - Ошибка

## Скорость UART

Согласно строкам 26-41 прошивки:
```c
TXSTA2=0x04; RCSTA2=0x90;  // 8N1, BRGH=1
SPBRG2=204;  // Было 188, затем изменили на 204
```

При FOSC = 64 MHz (с PLL):
- Скорость UART ≈ 19200 baud (нестандартная, зависит от реального Fosc)
- Рекомендуется проверить 19200, 9600, 10400 baud

## Выводы

✅ Все критические ошибки исправлены:
1. UDS адреса изменены на 0x28/0xF0
2. Код сервиса ответа изменен на 0x61
3. Индекс начала данных исправлен на 4
4. Добавлена проверка адресов в ответе
5. Парсер данных обновлен согласно структуре прошивки

## Тестирование

Для проверки работоспособности:
1. Подключиться к БСКУ через Bluetooth
2. Отправить StartCommunication (0x81)
3. Запустить периодическую отправку TesterPresent (0x3E 0x01) каждые 1.5 сек
4. Запросить диагностические данные (0x21 0x01)
5. Проверить логи на корректность приема ответа 0x61

Все изменения задокументированы и соответствуют актуальной прошивке.
