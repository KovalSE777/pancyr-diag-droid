# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

**–î–∞—Ç–∞:** 2025-10-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üìã –û–ë–ó–û–†

–ü—Ä–æ—Ç–æ–∫–æ–ª —Å–≤—è–∑–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **DB_BluetoothMonitorS_05_09_25.apk**.

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. ‚úÖ **ASCII –∫–æ–º–∞–Ω–¥—ã** –≤–º–µ—Å—Ç–æ UDS
2. ‚úÖ **38-–±–∞–π—Ç–Ω—ã–π —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ 7-–±–∞–π—Ç–Ω–æ–≥–æ
3. ‚úÖ **–ü–∞—Ä—Å–µ—Ä 0xFF –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤** –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –ë–°–ö–£
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—Ä–µ–π–º–æ–≤** 0x66 –∏ 0x77
5. ‚úÖ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º** Direct Control (—Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ fallback)

---

## üîÑ –ù–û–í–´–ô –ü–†–û–¢–û–ö–û–õ

### –ö–æ–º–∞–Ω–¥—ã –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫ –ë–°–ö–£:

#### 1. UCONF - –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```
ASCII: "UCONF"
HEX: 0x55 0x43 0x4F 0x4E 0x46
–†–∞–∑–º–µ—Ä: 5 –±–∞–π—Ç
–ö–æ–≥–¥–∞: –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–æ–¥–∏–Ω —Ä–∞–∑)
```

#### 2. UOKS - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
```
ASCII: "UOKS" + screenId (–±–∞–π—Ç)
HEX: 0x55 0x4F 0x4B 0x53 0x04
–†–∞–∑–º–µ—Ä: 5 –±–∞–π—Ç
–ö–æ–≥–¥–∞: –í –æ—Ç–≤–µ—Ç –Ω–∞ —Ñ—Ä–µ–π–º 0x66 –æ—Ç –ë–°–ö–£
```

#### 3. UOKP - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```
ASCII: "UOKP" + pktId (–±–∞–π—Ç)
HEX: 0x55 0x4F 0x4B 0x50 <pktId>
–†–∞–∑–º–µ—Ä: 5 –±–∞–π—Ç
–ö–æ–≥–¥–∞: –í –æ—Ç–≤–µ—Ç –Ω–∞ —Ñ—Ä–µ–π–º 0x77 –æ—Ç –ë–°–ö–£
```

#### 4. –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å (38 –±–∞–π—Ç)
```
–§–æ—Ä–º–∞—Ç: [0x44, 0x04, 0x07, 0x00√ó7, 0x4F, ..., CHK]
–†–∞–∑–º–µ—Ä: 38 –±–∞–π—Ç
–ö–æ–≥–¥–∞: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 500ms
```

### –û—Ç–≤–µ—Ç—ã –æ—Ç –ë–°–ö–£ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:

```
–ó–∞–≥–æ–ª–æ–≤–æ–∫: 0xFF √ó 7 (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
–¢–∏–ø/ScreenId: 1 –±–∞–π—Ç (0x01, 0x04, 0x66, 0x77)
–î–∞–Ω–Ω—ã–µ: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
```

---

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `src/utils/protocol-parser.ts`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `buildUCONF()` - ASCII –∫–æ–º–∞–Ω–¥–∞ "UCONF"
- `buildUOKS(screenId)` - ASCII –∫–æ–º–∞–Ω–¥–∞ "UOKS"
- `buildUOKP(pktId)` - ASCII –∫–æ–º–∞–Ω–¥–∞ "UOKP"
- `buildCyclicPoll()` - 38-–±–∞–π—Ç–Ω—ã–π —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –ø–∞–∫–µ—Ç
- `parseBskuPacket()` - –ø–∞—Ä—Å–µ—Ä —Å 0xFF –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- `enum BskuPacketType` - —Ç–∏–ø—ã –ø–∞–∫–µ—Ç–æ–≤
- `interface BskuPacket` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
- `buildDirectControl()` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
- `DirectControl_Poll` - fallback –æ–ø—Ä–æ—Å

### 2. `src/utils/capacitor-bluetooth.ts`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `startCommunication()` - –Ω–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å UCONF
- `startCyclicPolling()` - —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å 38-–±–∞–π—Ç–Ω—ã–º –ø–∞–∫–µ—Ç–æ–º
- `handleBskuPacket()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- `handleScreenChange()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ UOKS
- `handleConfiguration()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ UOKP
- `handleTelemetry()` - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `useNewProtocol` —Ñ–ª–∞–≥ - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏
- `cyclicPollInterval` - —Ç–∞–π–º–µ—Ä —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞
- Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –ø–∞—Ä—Å–µ—Ä –µ—Å–ª–∏ –Ω–æ–≤—ã–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 3. `src/utils/bluetooth-constants.ts`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- –ü–æ—è—Å–Ω–µ–Ω–∏—è –ø–æ ASCII –∫–æ–º–∞–Ω–¥–∞–º
- –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ (0xFF –∑–∞–≥–æ–ª–æ–≤–∫–∏)

---

## üéØ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –†–ê–ë–û–¢–´

### –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:

```
1. Bluetooth –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   ‚Üì
2. –ü–∞—É–∑–∞ 200ms (—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è)
   ‚Üì
3. –û—Ç–ø—Ä–∞–≤–∫–∞ UCONF
   ‚Üì
4. –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ 500ms
   ‚Üì
5. –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞ (500ms –∏–Ω—Ç–µ—Ä–≤–∞–ª)
```

### –í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:

```
–ö–∞–∂–¥—ã–µ 500ms:
  ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ buildCyclicPoll() (38 –±–∞–π—Ç)
  ‚Üê –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ (0xFF –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –¥–∞–Ω–Ω—ã–µ)
  ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ Screen4Parser
  ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
```

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—Ä–µ–π–º–æ–≤:

```
–§—Ä–µ–π–º 0x66 (—Å–º–µ–Ω–∞ —ç–∫—Ä–∞–Ω–∞):
  ‚Üê –ë–°–ö–£ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç screenId
  ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç UOKS + screenId

–§—Ä–µ–π–º 0x77 (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è):
  ‚Üê –ë–°–ö–£ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç pktId + –¥–∞–Ω–Ω—ã–µ
  ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç UOKP + pktId
```

---

## üîÑ –†–ï–ñ–ò–ú–´ –†–ê–ë–û–¢–´

### –†–µ–∂–∏–º 1: –ù–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```typescript
useNewProtocol = true
```
- ASCII –∫–æ–º–∞–Ω–¥—ã (UCONF, UOKS, UOKP)
- 38-–±–∞–π—Ç–Ω—ã–π —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å
- –ü–∞—Ä—Å–µ—Ä —Å 0xFF –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

### –†–µ–∂–∏–º 2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π (fallback)
```typescript
useNewProtocol = false
```
- Direct Control (–ø—Ä—è–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- 7-–±–∞–π—Ç–Ω—ã–π –ø–∞–∫–µ—Ç –æ–ø—Ä–æ—Å–∞
- –°—Ç–∞—Ä—ã–π UDS-–ø–æ–¥–æ–±–Ω—ã–π –ø–∞—Ä—Å–µ—Ä

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–ª–∞–≥ `useNewProtocol` –≤ `capacitor-bluetooth.ts`

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –ü–†–û–¢–û–ö–û–õ–û–í

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä—ã–π (UDS/Direct) | –ù–æ–≤—ã–π (ASCII) |
|--------|---------------------|---------------|
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è | DirectControl_Poll | UCONF |
| –û–ø—Ä–æ—Å | 7 –±–∞–π—Ç | 38 –±–∞–π—Ç |
| –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ | HDR + body + CHK | 0xFF√ó7 + type + data |
| –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—Ä–µ–π–º—ã | –ù–µ—Ç | UOKS, UOKP |
| –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ | 8 –±–∞–π—Ç | 5-38 –±–∞–π—Ç |

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

- [ ] UCONF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (0x55 0x43 0x4F 0x4E 0x46)
- [ ] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –ë–°–ö–£
- [ ] –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç (38 –±–∞–π—Ç –∫–∞–∂–¥—ã–µ 500ms)
- [ ] –ó–∞–≥–æ–ª–æ–≤–æ–∫ 0xFF —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è
- [ ] –ù–∞ 0x66 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è UOKS
- [ ] –ù–∞ 0x77 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è UOKP
- [ ] –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è –ø–∞—Ä—Å–∏—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 30+ –º–∏–Ω—É—Ç

### –õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```
‚úÖ BT Serial: Starting NEW protocol (ASCII commands)
‚úÖ BT Serial: Sending UCONF...
‚úÖ BT Serial: NEW protocol started
‚úÖ BT Serial: Cyclic polling started (500ms)
‚úÖ BT-RX BSKU: Telemetry data (screen X)
‚úÖ BT-RX: Telemetry parsed (NEW protocol)
```

---

## üîß –û–¢–õ–ê–î–ö–ê

### –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ UCONF
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ë–°–ö–£
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ 0xFF –∑–∞–≥–æ–ª–æ–≤–∫–∞
4. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª: `useNewProtocol = false`
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º Direct Control

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
adb logcat | grep "BT Serial\|BT-RX\|BT-TX"

# –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π
npm run build
npx cap sync android
npx cap run android
```

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –ë–°–ö–£
- [ ] –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ 38-–±–∞–π—Ç–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] –î–æ—Ä–∞–±–æ—Ç–∫–∞ Screen4Parser –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-24
